{% comment %} {% load static %}
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Management Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-waterfall@latest/dist/chartjs-plugin-waterfall.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background-color: #f0f2f5; }
        .container { padding: 1.5em; max-width: 1400px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .header h1 { color: #1f2937; }
        .filters form { display: flex; gap: 1em; align-items: center; }
        .filters select, .filters button { padding: 0.5em 1em; border-radius: 6px; border: 1px solid #d1d5db; }
        
        /* --- STYLE UNTUK NAVIGASI --- */
        .nav-links { 
            background-color: white; 
            padding: 1em; 
            margin-top: 1.5em; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border-bottom: 1px solid #e5e7eb;
        }
        .nav-links a {
            margin-right: 20px;
            text-decoration: none;
            color: #3b82f6;
            font-weight: 500;
        }
        .nav-links a:hover { text-decoration: underline; }
        /* --------------------------- */

        .summary-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5em; margin: 1.5em 0; }
        .card { background-color: white; padding: 1.5em; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .card h3 { margin: 0 0 0.5em 0; color: #6b7280; font-size: 0.9rem; font-weight: 500; }
        .card p { margin: 0; font-size: 2.25rem; font-weight: 700; color: #111827; }
        .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5em; }
        .chart-container { background-color: white; padding: 1.5em; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        h2 { color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5em; margin-top: 2em;}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Management Dashboard</h1>
            <div class="filters">
                <form method="GET">
                    <label for="batch-select">Pilih Batch untuk Detail:</label>
                    <select name="batch" id="batch-select" onchange="this.form.submit()">
                        <option value="">-- Ringkasan Semua Batch --</option>
                        {% for data in completed_batches %}
                            <option value="{{ data.pk }}" {% if selected_batch_id|stringformat:"s" == data.pk|stringformat:"s" %}selected{% endif %}>
                                {{ data.batch.batch_number }} - {{ data.batch.product.name }}
                            </option>
                        {% endfor %}
                    </select>
                </form>
            </div>
        </div>

        <div class="nav-links">
            <a href="{% url 'home' %}">üè† Halaman Utama</a>
            <a href="{% url 'product_list' %}">Kelola Produk (MSTD)</a>
            <a href="{% url 'issue_list' %}">Lihat Laporan Isu</a>
            <a href="{% url 'notification_list' %}">Lihat Notifikasi</a>
        </div>
        <div class="summary-cards">
            <div class="card">
                <h3>Total Batch Selesai</h3>
                <p>{{ total_batches }}</p>
            </div>
            <div class="card">
                <h3>Rata-rata Yield Aktual</h3>
                <p>{{ average_yield }}%</p>
            </div>
            <div class="card">
                <h3>Rata-rata Target Yield</h3>
                <p>{{ average_target }}%</p>
            </div>
        </div>
        
        {% if selected_batch_data %}
            <h2>Detail Yield untuk Batch: {{ selected_batch_data.batch.batch_number }}</h2>
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Waterfall Chart - Aliran Loss</h3>
                    <canvas id="waterfallChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Final Yield vs Target</h3>
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        {% else %}
            <div class="chart-container" style="text-align: center; padding: 3em;">
                <p>Silakan pilih batch dari menu di atas untuk melihat detail grafik.</p>
            </div>
        {% endif %}
    </div>

    {% if selected_batch_data %}
    <script>
        // Data dari Django
        const waterfallLabels = {{ waterfall_labels|safe }};
        const waterfallData = {{ waterfall_data|safe }};

        // 1. Konfigurasi Waterfall Chart
        const wfCtx = document.getElementById('waterfallChart');
        new Chart(wfCtx, {
            type: 'bar',
            data: {
                labels: waterfallLabels,
                datasets: [{
                    label: 'Yield Flow (pcs)',
                    data: waterfallData,
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.6)', // Theoretical
                        'rgba(255, 99, 132, 0.6)',  // Loss
                        'rgba(255, 99, 132, 0.6)',  // Loss
                        'rgba(255, 99, 132, 0.6)',  // Loss
                        'rgba(255, 99, 132, 0.6)',  // Loss
                        'rgba(255, 99, 132, 0.6)',  // Loss
                        'rgba(255, 99, 132, 0.6)',  // Loss
                    ],
                    borderColor: 'rgba(0, 0, 0, 0.2)',
                    borderWidth: 1,
                    waterfall: { calculating: true }
                }]
            },
            options: {
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                let value = context.raw;
                                if (context.label.startsWith('Loss')) {
                                    return `${context.label}: ${-value} pcs`;
                                }
                                return `${context.label}: ${value} pcs`;
                            }
                        }
                    }
                },
                scales: { y: { beginAtZero: true } }
            }
        });

        // 2. Konfigurasi Bar Chart (Yield vs Target)
        const barCtx = document.getElementById('barChart');
        new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: ['Yield Performance'],
                datasets: [{
                    label: 'Actual Yield (%)',
                    data: [{{ selected_batch_data.final_yield_percentage }}],
                    backgroundColor: 'rgba(75, 192, 192, 0.6)'
                }, {
                    label: 'Target Yield (%)',
                    data: [{{ selected_batch_data.target_yield }}],
                    backgroundColor: 'rgba(255, 159, 64, 0.6)'
                }]
            },
            options: {
                scales: { y: { beginAtZero: true, max: 110 } }
            }
        });
    </script>
    {% endif %}
</body>
</html> {% endcomment %}